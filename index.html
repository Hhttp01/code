<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Path Forge Pro | System Sync Engine</title>
    
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <link rel="stylesheet" href="style.css">
</head>
<body class="bg-slate-950 text-slate-200">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const App = () => {
            const [projectName, setProjectName] = useState("");
            const [tree, setTree] = useState(null);
            const [pathInput, setPathInput] = useState("");
            const [editingFile, setEditingFile] = useState(null);
            const [expandedFolders, setExpandedFolders] = useState(new Set(['root']));
            const [isSyncing, setIsSyncing] = useState(false);
            const [contextMenu, setContextMenu] = useState(null);

            // טעינה ושמירה אוטומטית (Local Storage)
            useEffect(() => {
                const saved = localStorage.getItem('pathforge_github_v1');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    setTree(parsed.tree);
                    setProjectName(parsed.projectName);
                }
            }, []);

            useEffect(() => {
                if (tree) {
                    localStorage.setItem('pathforge_github_v1', JSON.stringify({ tree, projectName }));
                }
                if (window.lucide) lucide.createIcons();
            }, [tree, projectName]);

            // מנוע סנכרון למחשב - כולל סינון קבצים ריקים
            const syncToSystem = async () => {
                try {
                    const rootHandle = await window.showDirectoryPicker();
                    setIsSyncing(true);
                    
                    const processNode = async (node, handle) => {
                        if (node.type === 'file') {
                            // הדרישה שלך: רק קבצים שהודבק בהם תוכן
                            if (node.content && node.content.trim().length > 0) {
                                const fileHandle = await handle.getFileHandle(node.name, { create: true });
                                const writable = await fileHandle.createWritable();
                                await writable.write(node.content);
                                await writable.close();
                            }
                        } else {
                            const dirHandle = await handle.getDirectoryHandle(node.name, { create: true });
                            for (const child of node.children) await processNode(child, dirHandle);
                        }
                    };

                    for (const child of tree.children) await processNode(child, rootHandle);
                    alert("הסנכרון הושלם בהצלחה!");
                } catch (err) {
                    if (err.name !== 'AbortError') alert("שגיאה בגישה למחשב.");
                } finally { setIsSyncing(false); }
            };

            const addPath = () => {
                if (!pathInput.trim()) return;
                const parts = pathInput.split('/').filter(Boolean);
                const newTree = { ...tree };
                let current = newTree;

                parts.forEach((part, i) => {
                    const isFile = i === parts.length - 1 && part.includes('.');
                    let found = current.children.find(c => c.name === part);
                    if (!found) {
                        found = {
                            id: Math.random().toString(36).substr(2, 9),
                            name: part,
                            type: isFile ? 'file' : 'folder',
                            content: isFile ? '' : undefined,
                            children: isFile ? undefined : []
                        };
                        current.children.push(found);
                    }
                    if (found.type === 'folder') {
                        current = found;
                        setExpandedFolders(prev => new Set(prev).add(found.id));
                    }
                });
                setTree(newTree);
                setPathInput("");
            };

            const TreeNode = ({ node, depth = 0, parent }) => {
                const isExpanded = expandedFolders.has(node.id);
                return (
                    <div className="fade-in">
                        <div 
                            className={`flex items-center py-1.5 px-4 cursor-pointer file-tree-item ${editingFile?.id === node.id ? 'bg-blue-500/10 text-blue-400 border-r-2 border-blue-500' : ''}`}
                            style={{ paddingRight: `${depth * 1.2}rem` }}
                            onClick={() => node.type === 'folder' ? setExpandedFolders(prev => {
                                const n = new Set(prev); n.has(node.id) ? n.delete(node.id) : n.add(node.id); return n;
                            }) : setEditingFile(node)}
                            onContextMenu={(e) => { e.preventDefault(); setContextMenu({ x: e.pageX, y: e.pageY, node, parent }); }}
                        >
                            <span className="ml-2 opacity-30">
                                {node.type === 'folder' ? (isExpanded ? <i data-lucide="chevron-down" size="14"></i> : <i data-lucide="chevron-right" size="14"></i>) : <i data-lucide="file-code" size="14"></i>}
                            </span>
                            {node.type === 'folder' && <i data-lucide="folder" className="ml-2 text-amber-500 fill-amber-500/10" size="16"></i>}
                            <span className="text-sm truncate font-medium">{node.name}</span>
                        </div>
                        {node.type === 'folder' && isExpanded && (
                            <div className="border-r border-slate-800/50 mr-4">
                                {node.children.map(c => <TreeNode key={c.id} node={c} depth={depth + 1} parent={node} />)}
                            </div>
                        )}
                    </div>
                );
            };

            if (!tree) {
                return (
                    <div className="h-screen flex items-center justify-center bg-slate-950">
                        <div className="glass-panel p-10 rounded-3xl w-full max-w-md shadow-2xl text-center fade-in">
                            <h2 className="text-3xl font-black mb-6">Path Forge <span className="text-blue-500">Pro</span></h2>
                            <input autoFocus className="w-full bg-slate-900 border border-slate-800 p-4 rounded-xl mb-4 outline-none focus:ring-2 focus:ring-blue-500 text-white transition-all" placeholder="שם הפרויקט..." value={projectName} onChange={e => setProjectName(e.target.value)} onKeyDown={e=>e.key==='Enter' && setTree({type:'folder', name:projectName, children:[], id:'root'})} />
                            <button onClick={() => setTree({type:'folder', name:projectName, children:[], id:'root'})} className="w-full bg-blue-600 hover:bg-blue-500 py-4 rounded-xl font-bold transition-all shadow-lg shadow-blue-900/20 active:scale-95">צור פרויקט חדש</button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="h-screen flex flex-col fade-in">
                    <header className="h-16 border-b border-slate-800 flex items-center justify-between px-8 glass-panel shrink-0">
                        <div className="flex items-center gap-4">
                            <div className="w-8 h-8 bg-blue-600 rounded flex items-center justify-center shadow-lg shadow-blue-600/20"><i data-lucide="terminal" size="18"></i></div>
                            <h1 className="font-bold tracking-tight">{projectName}</h1>
                        </div>
                        <button onClick={syncToSystem} className="bg-emerald-600 hover:bg-emerald-500 px-6 py-2 rounded-full font-bold flex items-center gap-2 transition-all shadow-lg shadow-emerald-900/20 active:scale-95">
                            <i data-lucide={isSyncing ? "loader" : "save"} className={isSyncing ? "animate-spin" : ""}></i>
                            {isSyncing ? "סנכרון..." : "סנכרן תיקייה למחשב"}
                        </button>
                    </header>

                    <div className="flex-1 flex overflow-hidden">
                        <aside className="w-72 border-l border-slate-800 flex flex-col shrink-0 bg-slate-900/10">
                            <div className="p-4 border-b border-slate-800/50">
                                <div className="relative group">
                                    <input className="w-full bg-slate-900 border border-slate-800 pl-3 pr-10 py-2 rounded-lg text-xs outline-none focus:border-blue-500 transition-all" placeholder="נתיב: src/App.js" value={pathInput} onChange={e => setPathInput(e.target.value)} onKeyDown={e => e.key === 'Enter' && addPath()} />
                                    <i data-lucide="plus" className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-500" size="14"></i>
                                </div>
                            </div>
                            <div className="flex-1 overflow-y-auto custom-scrollbar">
                                {tree.children.map(c => <TreeNode key={c.id} node={c} parent={tree} />)}
                            </div>
                        </aside>

                        <main className="flex-1 flex flex-col editor-area">
                            {editingFile ? (
                                <div className="h-full flex flex-col fade-in">
                                    <div className="h-10 flex items-center px-6 border-b border-slate-800/50 bg-slate-900/30">
                                        <span className="text-[10px] mono text-blue-400 uppercase tracking-widest">{editingFile.name}</span>
                                    </div>
                                    <textarea 
                                        className="flex-1 w-full p-10 bg-transparent outline-none resize-none mono text-sm leading-relaxed text-slate-300"
                                        placeholder="// הדבק את הקוד כאן..."
                                        value={editingFile.content}
                                        spellCheck="false"
                                        onChange={e => { editingFile.content = e.target.value; setTree({...tree}); }}
                                    />
                                </div>
                            ) : (
                                <div className="h-full flex flex-col items-center justify-center opacity-10">
                                    <i data-lucide="code-2" size="100"></i>
                                    <p className="mt-4 text-xl font-black">SELECT A FILE</p>
                                </div>
                            )}
                        </main>
                    </div>

                    {contextMenu && (
                        <div className="context-menu glass-panel rounded-xl overflow-hidden shadow-2xl" style={{ top: contextMenu.y, left: contextMenu.x }} onMouseLeave={() => setContextMenu(null)}>
                            <button className="w-full text-right px-4 py-3 hover:bg-slate-800 text-xs flex items-center justify-between" onClick={() => {
                                const n = prompt('שם חדש:', contextMenu.node.name);
                                if(n) { contextMenu.node.name = n; setTree({...tree}); }
                                setContextMenu(null);
                            }}>שנה שם <i data-lucide="edit" size="12"></i></button>
                            <button className="w-full text-right px-4 py-3 hover:bg-red-900/20 text-red-500 text-xs flex items-center justify-between" onClick={() => {
                                contextMenu.parent.children = contextMenu.parent.children.filter(i => i.id !== contextMenu.node.id);
                                if(editingFile?.id === contextMenu.node.id) setEditingFile(null);
                                setTree({...tree}); setContextMenu(null);
                            }}>מחק <i data-lucide="trash-2" size="12"></i></button>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
        
        // אתחול אייקונים
        setInterval(() => { if(window.lucide) lucide.createIcons(); }, 1000);
    </script>
</body>
</html>
